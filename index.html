<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>RushLife Prototype (Predios + Otimizado)</title>
<style>
  :root{
    --bg:#0f0f0f;
    --panel:#222;
    --panel2:#2b2b2b;
    --text:#fff;
    --muted:#bdbdbd;
  }
  body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    font-family: Arial, sans-serif;
    height:100vh;
    overflow:hidden;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  #wrap{
    width:min(420px, 100vw);
    height:min(820px, 100vh);
    position:relative;
  }
  #game{
    width:100%;
    height:100%;
    display:block;
    background:#0b0b0b;
    border-radius:18px;
    box-shadow:0 0 30px rgba(0,0,0,.6);
  }
  #hudTop{
    position:absolute;
    top:12px;
    left:12px;
    right:12px;
    display:flex;
    gap:10px;
    align-items:flex-start;
    pointer-events:none;
  }
  .hudCard{
    background:rgba(20,20,20,.75);
    border:1px solid rgba(255,255,255,.08);
    backdrop-filter: blur(6px);
    border-radius:14px;
    padding:10px 12px;
    font-size:13px;
    pointer-events:none;
    white-space: pre-line;
  }
  #hudLeft{ min-width: 170px; }
  #hudRight{ margin-left:auto; text-align:right; }

  #toast{
    position:absolute;
    left:50%;
    bottom:200px;
    transform:translateX(-50%);
    background:rgba(20,20,20,.9);
    border:1px solid rgba(255,255,255,.08);
    padding:10px 12px;
    border-radius:12px;
    display:none;
    max-width:340px;
    font-size:14px;
    text-align:center;
    box-shadow:0 10px 30px rgba(0,0,0,.35);
  }

  /* ==== PHONE OVERLAY ==== */
  #phoneOverlay{
    position:absolute;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    background:rgba(0,0,0,.55);
  }
  #phone{
    width:340px;
    height:610px;
    border-radius:28px;
    background:linear-gradient(180deg, #1c1c1c, #121212);
    box-shadow:0 0 35px rgba(0,0,0,.75);
    padding:18px;
  }
  #phone h2{ margin:4px 0 8px 0; }
  .muted{ color:var(--muted); font-size:13px; }
  .appbtn{
    width:100%;
    padding:12px 12px;
    margin:8px 0;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.08);
    background:var(--panel2);
    color:var(--text);
    font-size:16px;
  }
  .row{
    display:flex;
    gap:8px;
  }
  .row .appbtn{ flex:1; }

  /* ==== MOBILE CONTROLS ==== */
  #controls{
    position:absolute;
    left:12px; right:12px; bottom:12px;
    display:flex;
    justify-content:space-between;
    gap:12px;
    pointer-events:auto;
  }
  .pad{
    width:168px;
    height:168px;
    border-radius:18px;
    background:rgba(20,20,20,.55);
    border:1px solid rgba(255,255,255,.08);
    display:grid;
    grid-template-columns:repeat(3, 1fr);
    grid-template-rows:repeat(3, 1fr);
    gap:6px;
    padding:10px;
    backdrop-filter: blur(6px);
  }
  .btn{
    border:none;
    border-radius:14px;
    background:rgba(255,255,255,.08);
    color:#fff;
    font-size:18px;
  }
  .btn:active{ transform:scale(.98); }
  .btn.empty{ background:transparent; }

  .actions{
    width:180px;
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .act{
    padding:12px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.08);
    background:rgba(20,20,20,.55);
    color:#fff;
    font-size:16px;
    backdrop-filter: blur(6px);
  }
  .act:active{ transform:scale(.99); }
</style>
</head>
<body>
<div id="wrap">
  <canvas id="game" width="420" height="820"></canvas>

  <div id="hudTop">
    <div class="hudCard" id="hudLeft"></div>
    <div class="hudCard" id="hudRight"></div>
  </div>

  <div id="toast"></div>

  <!-- Phone overlay -->
  <div id="phoneOverlay">
    <div id="phone">
      <h2>üì± RushLife</h2>
      <div class="muted" id="phoneMeta"></div>
      <hr style="border-color:rgba(255,255,255,.08)">
      <div class="muted" id="phoneStatus"></div>

      <div class="muted" id="placeHint" style="margin:8px 0 2px 0;"></div>

      <button class="appbtn" id="btnDelivery" onclick="work('delivery')">üö¥ Trabalhar Entrega (+$20)</button>
      <button class="appbtn" id="btnUber" onclick="work('uber')">üöó Trabalhar Uber (+$30)</button>

      <div class="row">
        <button class="appbtn" id="btnEat" onclick="eat()">üçî Comer (-$15)</button>
        <button class="appbtn" id="btnSleep" onclick="sleep()">üåô Dormir</button>
      </div>

      <button class="appbtn" onclick="togglePhone()">‚¨ÖÔ∏è Fechar Celular</button>

      <div class="muted" style="margin-top:8px;">
        Dica: Interaja perto de pr√©dios (casa/lanchonete/trabalho) pra liberar a√ß√µes ‚Äúcertas‚Äù.
      </div>
    </div>
  </div>

  <!-- Mobile controls -->
  <div id="controls">
    <div class="pad">
      <button class="btn empty"></button>
      <button class="btn" id="up">‚¨ÜÔ∏è</button>
      <button class="btn empty"></button>
      <button class="btn" id="left">‚¨ÖÔ∏è</button>
      <button class="btn empty"></button>
      <button class="btn" id="right">‚û°Ô∏è</button>
      <button class="btn empty"></button>
      <button class="btn" id="down">‚¨áÔ∏è</button>
      <button class="btn empty"></button>
    </div>
    <div class="actions">
      <button class="act" onclick="togglePhone()">üì± Celular</button>
      <button class="act" onclick="interact()">ü§ù Interagir</button>
      <button class="act" onclick="toggleWeather()">üå¶Ô∏è Trocar Clima</button>
    </div>
  </div>
</div>

<script>
/* =========================
   GAME STATE
========================= */
const game = {
  day: 1,
  hour: 8,
  minute: 0,
  climate: "Sol", // Sol | Chuva | Nublado | Frio
  hunger: 100,
  energy: 100,
  health: 100,
  money: 50,
  age: 18.00,

  mapW: 2000,
  mapH: 2000,

  player: { x: 1000, y: 1000, speed: 180 },

  npcs: [
    { x: 950, y: 1050, vx: 0, vy: 0, dirT: 0, talk:"Oi! Bom dia üòä" },
    { x: 1100, y: 980, vx: 0, vy: 0, dirT: 0, talk:"T√° chovendo hoje?" },
    { x: 1020, y: 1120, vx: 0, vy: 0, dirT: 0, talk:"Trabalhar t√° dif√≠cil..." }
  ],

  // NOVO: pr√©dios/POIs com zona de intera√ß√£o
  places: [
    { id:"home",   name:"Casa",        icon:"üè†", x: 820,  y: 820,  w: 160, h: 120, radius: 120 },
    { id:"food",   name:"Lanchonete",  icon:"üçî", x: 1210, y: 760,  w: 180, h: 130, radius: 130 },
    { id:"work",   name:"Central Job", icon:"üíº", x: 1180, y: 1260, w: 200, h: 150, radius: 140 },
  ],

  phoneOpen: false,
  // ‚Äúcontexto‚Äù do celular: onde o player est√°
  atPlaceId: null
};

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

/* =========================
   HELPERS
========================= */
function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

function fmtTime(){
  const hh = String(game.hour).padStart(2,"0");
  const mm = String(game.minute).padStart(2,"0");
  return `${hh}:${mm}`;
}

let toastT = null;
function notify(msg){
  const el = document.getElementById("toast");
  el.textContent = msg;
  el.style.display = "block";
  clearTimeout(toastT);
  toastT = setTimeout(()=> el.style.display = "none", 1600);
}

/* =========================
   HUD + PHONE MODE
========================= */
function updateHUD(){
  const left =
`üìÖ Dia ${game.day} ‚Ä¢ üïí ${fmtTime()}
üå¶Ô∏è ${game.climate}`;
  const right =
`üí∞ $${game.money}
üçî ${game.hunger}  ‚ö° ${game.energy}
‚ù§Ô∏è ${game.health}  üéÇ ${game.age.toFixed(2)}`;

  document.getElementById("hudLeft").textContent = left;
  document.getElementById("hudRight").textContent = right;
  document.getElementById("phoneMeta").textContent = `Dia ${game.day} ‚Ä¢ ${fmtTime()} ‚Ä¢ Clima: ${game.climate}`;
  document.getElementById("phoneStatus").innerHTML =
    `üí∞ Dinheiro: $${game.money}<br>`+
    `üçî Fome: ${game.hunger}<br>`+
    `‚ö° Energia: ${game.energy}<br>`+
    `‚ù§Ô∏è Sa√∫de: ${game.health}<br>`+
    `üéÇ Idade: ${game.age.toFixed(2)}`;

  updatePhoneAvailability();
}

function updatePhoneAvailability(){
  const place = game.atPlaceId ? game.places.find(p=>p.id===game.atPlaceId) : null;

  const hint = document.getElementById("placeHint");
  const btnEat = document.getElementById("btnEat");
  const btnSleep = document.getElementById("btnSleep");
  const btnDel = document.getElementById("btnDelivery");
  const btnUber = document.getElementById("btnUber");

  // default: tudo ‚Äúmeio livre‚Äù, mas com dica
  if(!place){
    hint.textContent = "üìç Voc√™ est√° na rua. Dica: aproxime-se de pr√©dios para a√ß√µes especiais.";
    btnEat.disabled = false;
    btnSleep.disabled = false;
    btnDel.disabled = false;
    btnUber.disabled = false;
    btnEat.style.opacity = btnSleep.style.opacity = btnDel.style.opacity = btnUber.style.opacity = "1";
    return;
  }

  hint.textContent = `üìç Voc√™ est√° em: ${place.icon} ${place.name}`;

  // regras simples por lugar
  const atHome = place.id === "home";
  const atFood = place.id === "food";
  const atWork = place.id === "work";

  // Comer ‚Äúmelhor‚Äù na lanchonete, dormir ‚Äúmelhor‚Äù em casa, trabalhar ‚Äúmelhor‚Äù no trabalho
  btnSleep.disabled = !atHome;
  btnEat.disabled = !atFood;
  btnDel.disabled = !atWork;
  btnUber.disabled = !atWork;

  btnSleep.style.opacity = atHome ? "1" : "0.35";
  btnEat.style.opacity   = atFood ? "1" : "0.35";
  btnDel.style.opacity   = atWork ? "1" : "0.35";
  btnUber.style.opacity  = atWork ? "1" : "0.35";
}

function togglePhone(){
  game.phoneOpen = !game.phoneOpen;
  document.getElementById("phoneOverlay").style.display = game.phoneOpen ? "flex" : "none";
}

/* =========================
   TIME (otimizado)
========================= */
function advanceTime(totalMinutes){
  if(totalMinutes <= 0) return;

  // rel√≥gio
  let total = game.minute + totalMinutes;
  game.hour += Math.floor(total / 60);
  game.minute = total % 60;

  game.day += Math.floor(game.hour / 24);
  game.hour = game.hour % 24;

  // decay a cada 6 min
  const decays = Math.floor(totalMinutes / 6);
  if(decays > 0){
    game.hunger = clamp(game.hunger - decays, 0, 100);
    game.energy = clamp(game.energy - decays, 0, 100);
    if(game.hunger === 0 || game.energy === 0){
      game.health = clamp(game.health - decays, 0, 100);
    }
  }

  updateHUD();
}

function tickMinute(){ advanceTime(1); }
setInterval(tickMinute, 1000);

/* =========================
   ACTIONS
========================= */
function work(type){
  // s√≥ ‚Äúideal‚Äù no local de trabalho
  if(game.atPlaceId !== "work"){
    notify("Voc√™ precisa estar no üíº trabalho pra fazer jobs.");
    return;
  }
  if(game.energy <= 10){ notify("Voc√™ est√° muito cansado!"); return; }

  if(type === "delivery"){
    game.money += 20;
    game.energy = clamp(game.energy - 12, 0, 100);
    game.hunger = clamp(game.hunger - 8, 0, 100);
  } else {
    game.money += 30;
    game.energy = clamp(game.energy - 15, 0, 100);
    game.hunger = clamp(game.hunger - 10, 0, 100);
  }

  advanceTime(30);
}

function eat(){
  // s√≥ ‚Äúideal‚Äù na lanchonete
  if(game.atPlaceId !== "food"){
    notify("Voc√™ precisa estar na üçî lanchonete pra comer aqui.");
    return;
  }
  if(game.money < 15){ notify("Sem dinheiro suficiente."); return; }

  game.money -= 15;
  game.hunger = clamp(game.hunger + 45, 0, 100); // buff por comer no lugar certo
  game.energy = clamp(game.energy + 5, 0, 100);
  updateHUD();
}

function sleep(){
  // s√≥ ‚Äúideal‚Äù em casa
  if(game.atPlaceId !== "home"){
    notify("Voc√™ precisa estar em üè† casa pra dormir.");
    return;
  }

  advanceTime(8*60);
  game.energy = 100;
  game.hunger = clamp(game.hunger - 10, 0, 100);
  game.health = clamp(game.health + 5, 0, 100);
  game.age = Number((game.age + 0.01).toFixed(2));
  updateHUD();
}

function toggleWeather(){
  const list = ["Sol","Nublado","Chuva","Frio"];
  const idx = list.indexOf(game.climate);
  game.climate = list[(idx+1) % list.length];
  updateHUD();
}

/* =========================
   INPUT
========================= */
const keys = { up:false, down:false, left:false, right:false };
function setKey(k, v){ keys[k]=v; }

function bindHold(btnId, keyName){
  const el = document.getElementById(btnId);
  const down = () => setKey(keyName, true);
  const up = () => setKey(keyName, false);

  el.addEventListener("touchstart", (e)=>{ e.preventDefault(); down(); }, {passive:false});
  el.addEventListener("touchend", (e)=>{ e.preventDefault(); up(); }, {passive:false});
  el.addEventListener("touchcancel", (e)=>{ e.preventDefault(); up(); }, {passive:false});

  el.addEventListener("mousedown", down);
  el.addEventListener("mouseup", up);
  el.addEventListener("mouseleave", up);
}
bindHold("up","up");
bindHold("down","down");
bindHold("left","left");
bindHold("right","right");

window.addEventListener("keydown", (e)=>{
  if(e.key==="ArrowUp"||e.key==="w") keys.up=true;
  if(e.key==="ArrowDown"||e.key==="s") keys.down=true;
  if(e.key==="ArrowLeft"||e.key==="a") keys.left=true;
  if(e.key==="ArrowRight"||e.key==="d") keys.right=true;
  if(e.key===" ") togglePhone();
});
window.addEventListener("keyup", (e)=>{
  if(e.key==="ArrowUp"||e.key==="w") keys.up=false;
  if(e.key==="ArrowDown"||e.key==="s") keys.down=false;
  if(e.key==="ArrowLeft"||e.key==="a") keys.left=false;
  if(e.key==="ArrowRight"||e.key==="d") keys.right=false;
});

/* =========================
   INTERACTION (pr√©dios > NPC)
========================= */
function dist(a,b){
  const dx=a.x-b.x, dy=a.y-b.y;
  return Math.sqrt(dx*dx+dy*dy);
}

function getNearestNPC(){
  const p = game.player;
  let nearest = null;
  let best = 99999;
  for(const n of game.npcs){
    const d = dist(p,n);
    if(d < best){ best=d; nearest=n; }
  }
  return { nearest, best };
}

function getNearestPlace(){
  const p = game.player;
  let nearest = null;
  let best = 99999;
  for(const pl of game.places){
    const center = { x: pl.x + pl.w/2, y: pl.y + pl.h/2 };
    const d = dist(p, center);
    if(d < best){ best=d; nearest=pl; }
  }
  return { nearest, best };
}

function interact(){
  const { nearest: pl, best: pd } = getNearestPlace();
  if(pl && pd < pl.radius){
    game.atPlaceId = pl.id;
    updateHUD();
    notify(`Voc√™ entrou em ${pl.icon} ${pl.name}`);
    // abre o celular automaticamente no lugar
    if(!game.phoneOpen) togglePhone();
    return;
  }

  const { nearest, best } = getNearestNPC();
  if(nearest && best < 90){
    notify(nearest.talk);
  } else {
    notify("Ningu√©m perto para interagir.");
  }
}

/* =========================
   WEATHER FX (chuva animada)
========================= */
const rain = Array.from({length: 120}, ()=>({
  x: Math.random()*canvas.width,
  y: Math.random()*canvas.height,
  vx: 120 + Math.random()*60,
  vy: 360 + Math.random()*120
}));

function drawRain(dt){
  ctx.strokeStyle = "rgba(180,180,255,0.25)";
  ctx.lineWidth = 1;
  for(const r of rain){
    r.x += r.vx*dt;
    r.y += r.vy*dt;
    if(r.x > canvas.width+30) r.x = -30;
    if(r.y > canvas.height+30) r.y = -30;

    ctx.beginPath();
    ctx.moveTo(r.x, r.y);
    ctx.lineTo(r.x+6, r.y+18);
    ctx.stroke();
  }
}

/* =========================
   RENDER
========================= */
let lastDraw = performance.now();

function draw(t){
  const dt = Math.min(0.05, (t - lastDraw) / 1000);
  lastDraw = t;

  const p = game.player;
  const camX = clamp(p.x - canvas.width/2, 0, game.mapW - canvas.width);
  const camY = clamp(p.y - canvas.height/2, 0, game.mapH - canvas.height);

  ctx.clearRect(0,0,canvas.width,canvas.height);

  // base
  ctx.fillStyle = "#101010";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // roads grid
  ctx.fillStyle = "#1a1a1a";
  for(let x=0;x<game.mapW;x+=200){
    const sx = x - camX;
    if(sx>-220 && sx<canvas.width+220){
      ctx.fillRect(sx, -20, 60, canvas.height+40);
    }
  }
  for(let y=0;y<game.mapH;y+=200){
    const sy = y - camY;
    if(sy>-220 && sy<canvas.height+220){
      ctx.fillRect(-20, sy, canvas.width+40, 60);
    }
  }

  // places (pr√©dios)
  const nearPlace = getNearestPlace();
  for(const pl of game.places){
    const x = pl.x - camX;
    const y = pl.y - camY;

    // pr√©dio (ret√¢ngulo)
    ctx.fillStyle = "rgba(255,255,255,0.06)";
    ctx.fillRect(x, y, pl.w, pl.h);
    ctx.strokeStyle = "rgba(255,255,255,0.12)";
    ctx.lineWidth = 2;
    ctx.strokeRect(x, y, pl.w, pl.h);

    // highlight se perto
    if(nearPlace.nearest === pl && nearPlace.best < pl.radius){
      ctx.strokeStyle = "rgba(255,255,255,0.35)";
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.arc(x + pl.w/2, y + pl.h/2, Math.min(pl.radius, 120), 0, Math.PI*2);
      ctx.stroke();
    }

    // label
    ctx.fillStyle = "rgba(255,255,255,0.75)";
    ctx.font = "14px Arial";
    ctx.fillText(`${pl.icon} ${pl.name}`, x + 10, y + 22);
  }

  // weather overlay
  if(game.climate==="Chuva"){
    ctx.fillStyle = "rgba(120,120,255,0.06)";
    ctx.fillRect(0,0,canvas.width,canvas.height);
    drawRain(dt);
  } else if(game.climate==="Frio"){
    ctx.fillStyle = "rgba(200,240,255,0.06)";
    ctx.fillRect(0,0,canvas.width,canvas.height);
  } else if(game.climate==="Nublado"){
    ctx.fillStyle = "rgba(200,200,200,0.04)";
    ctx.fillRect(0,0,canvas.width,canvas.height);
  }

  // NPC highlight
  const nearNpc = getNearestNPC();

  // NPCs
  for(const n of game.npcs){
    const x = n.x - camX, y = n.y - camY;

    if(n === nearNpc.nearest && nearNpc.best < 90){
      ctx.strokeStyle = "rgba(255,255,255,0.35)";
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.arc(x, y, 20, 0, Math.PI*2);
      ctx.stroke();
    }

    ctx.fillStyle = "#7bd389";
    ctx.beginPath();
    ctx.arc(x, y, 12, 0, Math.PI*2);
    ctx.fill();

    ctx.fillStyle = "rgba(255,255,255,0.6)";
    ctx.fillRect(x-10, y-22, 20, 3);
  }

  // Player
  const px = p.x - camX, py = p.y - camY;
  ctx.fillStyle = "#ffd166";
  ctx.beginPath();
  ctx.arc(px, py, 14, 0, Math.PI*2);
  ctx.fill();

  ctx.strokeStyle = "rgba(0,0,0,0.4)";
  ctx.lineWidth = 3;
  ctx.stroke();

  requestAnimationFrame(draw);
}

/* =========================
   UPDATE LOOP
========================= */
let last = performance.now();
function update(t){
  const dt = Math.min(0.033, (t-last)/1000);
  last = t;

  if(!game.phoneOpen){
    const p = game.player;
    let dx = 0, dy = 0;
    if(keys.up) dy -= 1;
    if(keys.down) dy += 1;
    if(keys.left) dx -= 1;
    if(keys.right) dx += 1;

    const len = Math.hypot(dx,dy);
    if(len>0){ dx/=len; dy/=len; }

    p.x = clamp(p.x + dx*p.speed*dt, 20, game.mapW-20);
    p.y = clamp(p.y + dy*p.speed*dt, 20, game.mapH-20);

    // atualiza ‚Äúonde estou‚Äù automaticamente (entra/sai)
    const near = getNearestPlace();
    if(near.nearest && near.best < near.nearest.radius){
      game.atPlaceId = near.nearest.id;
    } else {
      game.atPlaceId = null;
    }
  }

  // NPC wandering
  for(const n of game.npcs){
    n.dirT -= dt;
    if(n.dirT <= 0){
      n.dirT = 1 + Math.random()*2;
      const a = Math.random()*Math.PI*2;
      n.vx = Math.cos(a)*60;
      n.vy = Math.sin(a)*60;
    }
    n.x = clamp(n.x + n.vx*dt, 20, game.mapW-20);
    n.y = clamp(n.y + n.vy*dt, 20, game.mapH-20);
  }

  requestAnimationFrame(update);
}

/* =========================
   START
========================= */
updateHUD();
requestAnimationFrame(update);
requestAnimationFrame(draw);
</script>
</body>
</html>
